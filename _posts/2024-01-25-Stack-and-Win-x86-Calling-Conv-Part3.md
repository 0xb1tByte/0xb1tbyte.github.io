---
layout: post
published: true
title: The Stack and Windows x86 Calling Conventions Part 3
date: '2024-01-25'
tags:
- Windows
- Windows Internals
- Arabic-Article
- System Security
---

<div dir="rtl" markdown="1">

ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู 

ูุฐู ุงูููุงูุฉ ุงุณุชููุงู ููุณูุณูุฉ ุงูุณุงุจูุฉ ุ ูุณุชููู ุงูุฃุฎูุฑุฉ ( ุฅูุง ุฅู ุงูุชุดููุง ููุถูุน ูููุงุฑุจ ููููุงุถูุน ูุฐู ูุฑููุจ ๐ ) 

ุงูููุงูุงุช ุงูุณุงุจูุฉ ูุงูุช ุชูููุฏ -ูููุฏูุฉ ูุงุจุฏ ูููุง- ูุจู ุงูุญุฏูุซ ุนู ููุงุถูุน ุงูููุงูุฉ ุงูุฃุฎูุฑุฉุ ูุงูููุงุท ุงูุชู ุณููุงูุดูุง ูู ููุงูุชูุง ูุฐู ูู : 
* C Declaration (`__cdecl`) Calling Convention
* Standard Call (`__stdcall`) Calling Convention
* Fast Call (`__fastcall`) Calling Convention

ุงููุฑุงุฌุน ูู ูุฐู ุงูููุงูุฉ ุจุดูู ุฃุณุงุณู ูู ุงููุชุงุจ ุงูุฑุงุฆุน `Practical Malware Analysis` ูุงููุฑุฌุน ุงูุฑุณูู ูู ูุงููุฑูุณููุช ุ ููููุง ูุชุญุฏุซ ููุง ุนู ุงูู Calling Convention ูู ุฃูุธูุฉ ูุงููุฑูุณููุช 

ููุจุฏุฃ ุจุณู ุงููู ุ

# ููุงุญุธุฉ

ูู ูุชุงุจ `Practical Malware Analysis` ูุจู ุงูุญุฏูุซ ุนู ุชูุงุตูู ุงูู Calling Conventions ูุฌุฏ ูุฐู ุงูููุงุญุธุฉ ุงููููุฉ

</div> 

> NOTE Although the same conventions can be implemented differently between compilers, weโll focus on the most common ways they are used.



<div dir="rtl" markdown="1">
ุจุงูุฌุงุฒุ ูุณุชุทูุน ุงูููู ูู ุงูููุงุญุธุฉ ุงูุณุงุจูุฉ ุฃู ุงูู Calling Conventions ูุฏ ูุฎุชูู ุชูููุฐูุง ( implementation ) ูู Compiler ูุขุฎุฑ ุ ูุฐูู ูุซู ูุง ุฐูุฑ ุงููุชุงุจ ุ ุณูุฑููุฒ ูู ุงูููุงูุฉ ูุฐู ุนูู ุงูููุงููู ุงูุนุงูุฉ ููู Calling Convention 


ุฃูุถูุง ูุฐุง ูู ุงูู Pseudocode ุงูุฐู ุณูุนุชูุฏ ุนููู ูู ุดุฑุญ ุงูุฌุฒุฆูุงุช ุงููุงุฏูุฉ 

</div> 


```c
 1 | int test(int x, int y, int z);
 2 | int a, b, c, ret;
 3 |
 4 | ret = test(a, b, c);
```

<div dir="rtl" markdown="1">

# C Declaration (`__cdecl`) Calling Convention

ูุฌุฏ ูู ุงููุฑุฌุน ุงูุฎุงุต [ุจูุงููุฑูุณููุช](https://learn.microsoft.com/en-us/cpp/cpp/cdecl?view=msvc-170) ุฃู ูุฐุง ุงูู Calling Convention ูู ุงูู default ูู ูุบุงุช C & C++ 


</div> 

> __cdecl is the default calling convention for C and C++ programs.

<div dir="rtl" markdown="1">

ุทูุจ ูุงูู ุงูููุงููู ูู ูุฐุง ุงูู Calling Convention ุ 

ุฅุฐุง ุชู ุงุณุชุฎุฏุงู ุงูู `__cdecl` ูุณูุชู ุงูุขุชู : 

ูก - ุณูุชู ุชูุฑูุฑ ุงูู `Parameters` ุงูู ุงูู `Stack` **ูู ุงููููู ุฅูู ุงููุณุงุฑ**

ูข - ุงูุฏุงูุฉ ุงููููุงุฏูุฉ ( `Caller` ) ุณุชููู ูู ุงููุณุคููุฉ ุนู ุนูููุฉ ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูู Stack ููุถุนู ุงูุฃููู ุจุนุฏ ุฃู ุชูููู ุงูุฏุงูุฉ ุงููููุงุฏุงุฉ ( `Callee` ) ุนูููุง 

ููุนูุฏ ููู Pseudocode ุงูุณุงุจู ููุฑุจุท ุงูููุงุท ุงูุชู ุฐูุฑูุงูุง ุฃุนูุงู ุจุงูููุฏ 

**ุงูููุทุฉ ุฑูู ูก**

ูู ุงูุณุทุฑ `4` ูุฌุฏ ูุฏุงุก ุงูุฏุงูุฉ `test` ุ ูููุงุญุธ ุฃูู ุชู ุชูุฑูุฑ ุงูู `Parameters` ุงูุชุงููุฉ : `a` , `b` , `c`

ูู ุญุงูุฉ ุงูู `__cdecl` ุณูุชู ุฃูููุง ุชุฎุฒูู ุงูู `c` ูู ุงูู `Stack` ููู ุซู ุงูู `b` ูุขุฎุฑูุง ุงูู `a`

**ุงูููุทุฉ ุฑูู ูข** 

ุงูุฏุงูุฉ ุงูุชู ุณุชููู ุจูุฏุงุก ุงูุฏุงูุฉ `test` ุณุชููู ูู ุงููุณุคููุฉ ุนู ุชูุธูู ุงูู `Stack`  ูุฅุนุงุฏุฉ ุงูู `registers` ููุถุนูุง ุจุนุฏ ุฃู ุชูููู ุงูุฏุงูุฉ `test` ุนูููุง 

ููุฏ ุงูุฃุณูุจูู ุงูุขุชู ูุนูู ููุถูุญ ุขููุฉ ุงูู `__cdecl`


</div>

```nasm
 1 | push c
 2 | push b
 3 | push a
 4 | call test
 5 | add esp, 12
 6 | mov ret, eax
```



<div dir="rtl" markdown="1">

ูุงุญุธ ูู ุงูุณุทุฑ `1` ุชู ุนูู `push` ููู `c` ุ ูุงูู `c` ูู ุขุฎุฑ `parameter` ุชู ุชูุฑูุฑู ููุช ูุฏุงุก ุงูุฏุงูุฉ `test` 
</div>

```c
 4 | ret = test(a, b, c);
```

<div dir="rtl" markdown="1">

ููู ุงูุณุทุฑ `2` ุชู ุชูุฑูุฑ ูููุฉ ุงูู `b` ููู `Stack` ูุจุนุฏู ุงูู `a` 

ููู ุงูุณุทุฑ ุฑูู `4` ุชู ูุฏุงุก ุงูุฏุงูุฉ `test` ุจุงูุชุนูููุฉ `CALL` ูุงูุชู ูุงูุดูุงูุง ูู ููุงูุฉ ุณุงุจูุฉ 

ุนูุฏ ูุฐู ุงูุฎุทูุฉ ุณููุชูู ุงูุชุญูู ููุฏุงูุฉ `test` ูุณูุชู ุงูุดุงุก `Stack Frame` ุฌุฏูุฏ ุฎุงุต ุจูุง 

ููู ุญุงู ุงูุชูุช ุงูุฏุงูุฉ `test` ูู ุนูููุง ุณูุชู ุฅุนุงุฏุฉ ุงูุชุญูู ููุฏุงูุฉ ุงููููุงุฏูุฉ ( `Caller` ) 

ูุณุชุชููู ุงูุฏุงูุฉ ุงููููุงุฏูุฉ ( `Caller` ) ุจุฅุนุงุฏุฉ ุงูู `Stack` ูุญุงูุชู ุงูุฃููู ุ ูุฐู ุงูุฎุทูุงุช ูุชู ุชูุบูุฐูุง ูู ุงูุณุทุฑ ุฑูู `5`

ุจุชูุตูู ุฃูุซุฑ : ุงูููุฏ ูู ุงูุณุทุฑ ุฑูู `5` ูููู ุจุงุถุงูุฉ `12` ุงูู ุงูู `ESP` ู ููุง ุนุฑููุง ูู ููุงูุฉ ุณุงุจูุฉุ ุงูู `Stack` ูููู **ุจุดูู ุนูุณู** ุ ูุนูููุฉ ุงูุฅุถุงูุฉ ููุง ูุฃูู ูุฑูุฏ ุฅุนุงุฏุฉ ุงูู `Stack` ยููุญุงูุฉ ุงูุฃููู

ูุจุงููุณุจุฉ ูููููุฉ ุงูุชู ูููุง ุจุฅุถุงูุชูุง ( `12` ) ูุฃูู ุชู ุชูุฑูุฑ `3` ูุชุบูุฑุงุช ( `Parameters` ) ููู ูุชุบููุฑ ูุฃุฎุฐ ูุณุงุญุฉ `4` ุจุงูุช ( ูุชุญุฏูุซ ููุง ุนู ุงูู 32bit systems )

# Standard Call (`__stdcall`) Calling Convention

ุงูู `__stdcall` ูุซู ุงูู `__cdecl` ููู ูุฎุชูู ุนูู ูู ุฃู ุงูุฏุงูุฉ ุงููููุงุฏุงุฉ ( `Callee` ) ูู ุงููุณุคููุฉ ุนู ุชูุธูู ูุฅุนุงุฏุฉ ุชููุฆุฉ ุงูู `Stack` 

ููู ุนุฏูุง ููุซุงููุง ุงูุณุงุจู ุณุชููู ุงูุฏุงูุฉ `test` ูู ุงููุณุคููุฉ ุนู ุชูุธูู ุงูู `Stack` ุ ูุนูู ูุฌู ุงูุชุญุฏูุฏุ ูุชู ุชูููุฐ ูุฐู ุงูุนูููุฉ ูู ุงูู `Epilogue` ุงูุฎุงุต ุจุงูุฏุงูุฉ `test` 

ูุฐูู ุงูู `__stdcall` ูู ุงูู Calling Convention ุงูุฐู ูุชู ุงุณุชุฎุฏุงูู ูู ุฏูุงู ุงูู `Win32 API` ุ ูุจูุบุฉ ุฃุฎุฑูุ ุฃู ุฏูุงู ุชููู ุจูุฏุงุก ุฏูุงู ุงูู `Win32 API` ูู ุชููู ูุณุคููุฉ ุนู ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูู `Stack` ุ ูุฃููุง ูุณุคูููุฉ ุฏูุงู ุงูู `Win32 API`

# Fast Call (`__fastcall`) Calling Convention

ูู ุงูู `__fastcall` ุณูุชู ุงูุขุชู : 

ูก - ุงูู Parameters ุงูุฃููู ( ุนุงุฏุฉู ุงููุชุบูุฑูู ุงูุฃููููู ) ุณูุชู ุชุฎุฒูููู ูู registers ( ุนุงุฏุฉู ูู ุงูู `ECX` ู `EDX` ) ูุจููุฉ ุงูู Parameters ูุชู ุชูุฑูุฑูุง ููู `Stack` **ูู ุงููููู ุฅูู ุงููุณุงุฑ**

ูข - ุนูููุฉ ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูู `Stack` ูู ูุณุคูููุฉ ุงูุฏุงูุฉ ุงููููุงุฏุงุฉ ( `Callee` ) 

ุงูุฌุฏูู ุงูุชุงูู ููุงุฑู ุจูู ุงูุฃููุงุน ุงูุซูุงุซ 

| Calling Convention | Stack Cleanup | Parameter Passing |
|-------------------|---------------|-------------------|
| `__cdecl`         | ุงูุฏุงูุฉ ุงููููุงุฏูุฉ ( `Caller` ) | ูุชู ุชูุฑูุฑูุง ููู `Stack` **ูู ุงููููู ุฅูู ุงููุณุงุฑ** |
| `__stdcall`       | ุงูุฏุงูุฉ ุงููููุงุฏุงุฉ (`Callee` ) | ูุชู ุชูุฑูุฑูุง ููู `Stack` **ูู ุงููููู ุฅูู ุงููุณุงุฑ** |
| `__fastcall`      | ุงูุฏุงูุฉ ุงููููุงุฏุงุฉ (`Callee` ) | ูุชู ุชุฎุฒูู ุฃูู ูุชุบููุฑู ูู registers ูุงูุจููุฉ ูุชู ุชูุฑูุฑูู ููู `Stack` |


</div>


> โน๏ธ [ููุงุญุธุฉ]
> ูุฐู ุงูููุงูุฉ ุชููุช ูุชุงุจุชูุง ุฎูุงู ุฏุฑุงุณุฉ ูุฐู ุงูููุงุถูุนุ ููู ูุง ุชู ุฐูุฑู ููุง ูุฏ ูุญุชูู ุงูุฎุทุฃุ ููู ุจุงูุฅููุงู ุงูุนูุฏุฉ ุฅูู ุงููุฑุงุฌุน ุงูุชู ุฅุณุชูุฏุช ุนูููุง ูุฐู ุงูููุงูุฉ 
